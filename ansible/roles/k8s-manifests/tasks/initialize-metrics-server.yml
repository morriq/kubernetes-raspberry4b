---
- name: create metrics server deployment
  kubernetes.core.k8s:
    apply: yes
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: metrics-server
        namespace: kube-system
        labels:
          k8s-app: metrics-server
      spec:
        selector:
          matchLabels:
            k8s-app: metrics-server
        template:
          metadata:
            name: metrics-server
            labels:
              k8s-app: metrics-server
          spec:
            priorityClassName: 'system-node-critical'
            serviceAccountName: metrics-server
            tolerations:
              - key: 'CriticalAddonsOnly'
                operator: 'Exists'
              - key: 'node-role.kubernetes.io/control-plane'
                operator: 'Exists'
                effect: 'NoSchedule'
              - key: 'node-role.kubernetes.io/master'
                operator: 'Exists'
                effect: 'NoSchedule'
            volumes:
              # mount in tmp so we can safely use from-scratch images and/or read-only containers
              - name: tmp-dir
                emptyDir: {}
            containers:
              - name: metrics-server
                image: rancher/metrics-server:v0.3.6
                command:
                  - /metrics-server
                  - --kubelet-preferred-address-types=InternalIP
                  - --kubelet-insecure-tls
                  - --v=2
                volumeMounts:
                  - name: tmp-dir
                    mountPath: /tmp
